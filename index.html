<!DOCTYPE html>
<html lang="ta">
<head>
  <meta charset="UTF-8">
  <title>தத்துவாரியர் பாடல்கள்</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Noto Sans Tamil', Latha, Arial, sans-serif;
      background: #f8f9fa;
      padding: 20px;
    }
    .poem {
      white-space: pre-wrap;
      background: #fff;
      border-radius: 8px;
      padding: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    mark {
      background: yellow;
      padding: 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="mb-4">தத்துவாரியர் பாடல்கள்</h1>

    <!-- Search Box -->
    <input type="text" id="searchBox" class="form-control mb-4" placeholder="தேடவும் (Title, Subtitle, அல்லது பாடல்)..." />

    <div class="accordion" id="titleAccordion"></div>
  </div>

  <script>
    const API_URL = "https://www.vallalar.co.in/api/thathuvaryar/";
    let fullData = [];  // Store full API response
    let currentQuery = "";

    // Highlight function
    function highlightText(text, query) {
      if (!query) return text;
      const regex = new RegExp(`(${query})`, "gi");
      return text.replace(regex, "<mark>$1</mark>");
    }

    // Render accordion UI
    function renderAccordion(data) {
      const titleAccordion = document.getElementById("titleAccordion");
      titleAccordion.innerHTML = ""; // clear old

      data.forEach((titleObj, tIndex) => {
        const titleItem = document.createElement("div");
        titleItem.className = "accordion-item";

        titleItem.innerHTML = `
          <h2 class="accordion-header" id="heading${tIndex}">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
              data-bs-target="#collapse${tIndex}" aria-expanded="false" aria-controls="collapse${tIndex}">
              ${highlightText(titleObj.title, currentQuery)}
            </button>
          </h2>
          <div id="collapse${tIndex}" class="accordion-collapse collapse" aria-labelledby="heading${tIndex}" 
            data-bs-parent="#titleAccordion">
            <div class="accordion-body" id="subtitleContainer${tIndex}"></div>
          </div>
        `;
        titleAccordion.appendChild(titleItem);

        const subtitleContainer = titleItem.querySelector(`#subtitleContainer${tIndex}`);
        const subtitleAccordion = document.createElement("div");
        subtitleAccordion.className = "accordion";
        subtitleAccordion.id = `subtitleAccordion${tIndex}`;
        subtitleContainer.appendChild(subtitleAccordion);

        titleObj.subtitles.forEach((sub, sIndex) => {
          const subItem = document.createElement("div");
          subItem.className = "accordion-item";
          subItem.innerHTML = `
            <h2 class="accordion-header" id="subHeading${tIndex}-${sIndex}">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                data-bs-target="#subCollapse${tIndex}-${sIndex}" aria-expanded="false" aria-controls="subCollapse${tIndex}-${sIndex}">
                ${highlightText(sub.subtitle, currentQuery)}
              </button>
            </h2>
            <div id="subCollapse${tIndex}-${sIndex}" class="accordion-collapse collapse" aria-labelledby="subHeading${tIndex}-${sIndex}" 
              data-bs-parent="#subtitleAccordion${tIndex}">
              <div class="accordion-body">
                ${sub.poems.map(p => `<div class="poem mb-2">${highlightText(p.poem.replace(/\r\n/g, "<br/>"), currentQuery)}</div>`).join("")}
              </div>
            </div>
          `;
          subtitleAccordion.appendChild(subItem);
        });
      });
    }

    // Fetch data
    fetch(API_URL)
      .then(res => res.json())
      .then(data => {
        fullData = data;
        renderAccordion(fullData);
      })
      .catch(err => {
        console.error("Error fetching data:", err);
        document.getElementById("titleAccordion").innerHTML = `<div class="alert alert-danger">⚠️ தரவுகளை ஏற்றுவதில் பிழை!</div>`;
      });

    // Search filter
    document.getElementById("searchBox").addEventListener("input", function () {
      currentQuery = this.value.toLowerCase();

      if (!currentQuery) {
        renderAccordion(fullData); // reset
        return;
      }

      const filtered = fullData.map(titleObj => {
        const matchedSubtitles = titleObj.subtitles.map(sub => {
          const matchedPoems = sub.poems.filter(p => p.poem.toLowerCase().includes(currentQuery));
          if (sub.subtitle.toLowerCase().includes(currentQuery) || matchedPoems.length > 0) {
            return { ...sub, poems: matchedPoems.length ? matchedPoems : sub.poems };
          }
          return null;
        }).filter(Boolean);

        if (titleObj.title.toLowerCase().includes(currentQuery) || matchedSubtitles.length > 0) {
          return { ...titleObj, subtitles: matchedSubtitles };
        }
        return null;
      }).filter(Boolean);

      renderAccordion(filtered);
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
